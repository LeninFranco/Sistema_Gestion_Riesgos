{% extends "templateSideBar.html" %}

{% block username %} {{usuario.nombre}} {% endblock %}

{% block content %}
{% with messages = get_flashed_messages() %}
{% if messages %}
<div class="row pt-5" id="alertRow">
    <div class="alert alert-{{messages[0]}} alert-dismissible fade show" role="alert">
        {{messages[1]}}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close" id="closeAlert"></button>
    </div>
</div>
{% endif %}
{% endwith %}

<div class="row pt-2 text-justify">
    <h2>Riesgos</h2>
    <p>Aquí puedes registrar todos los riesgos que identifiques en tu proyecto. Puedes incluir todos los detalles relevantes, seleccionar uno o varios activos que puedan estar amenazados por este riesgo, y evaluarlo según las variables de evaluación del OWASP Risk Rating.</p>
</div>
<div class="row pt-2">
    <button type="button" class="btn btn-dark bg-black w-100" data-bs-toggle="modal"
    data-bs-target="#VentanaAddRiesgo">Añadir Riesgo</button>
</div>
<div class="row pt-2">
    <div class="col-3">
        <select id="filter-tipo" class="form-select">
            <option value="">Filtrar por Tipo</option>
            {% for tipoRiesgo in tiposRiesgo %}
            <option value="{{tipoRiesgo}}">{{tipoRiesgo}}</option>
            {% endfor %}
        </select>
    </div>
    <div class="col-3">
        <select id="filter-umbral" class="form-select">
            <option value="">Filtrar por Umbral</option>
            <option value="Insignificante">Insignificante</option>
            <option value="Bajo">Bajo</option>
            <option value="Medio">Medio</option>
            <option value="Alto">Alto</option>
            <option value="Crítico">Crítico</option>
        </select>
    </div>
    <div class="col-3">
        <select id="filter-accion" class="form-select">
            <option value="">Filtrar Acciones Asignadas</option>
            <option value="no">Sin Acciones</option>
            <option value="si">Con Acciones</option>
        </select>
    </div>
    <div class="col-3">
        <input type="text" class="form-control w-100" id="search" name="search" placeholder="Buscar (Clave o Nombre)"
            autocomplete="off">
    </div>
</div>
<div class="row pt-2">
    <div class="modal fade" id="VentanaAddRiesgo" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
        aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Registrar Riesgos</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form action="/anadir-riesgo" id="formularioRiesgos" method="post" autocomplete="off">
                        <div class="row">
                            <div class="mb-3">
                                <input type="text" name="clave" value="{{claveSig}}" class="form-control"
                                    placeholder="Clave de identificación del riesgo" required autofocus>
                            </div>
                        </div>
                        <div class="row">
                            <div class="mb-3">
                                <input type="text" name="nombre" class="form-control" placeholder="Nombre del riesgo"
                                    required autofocus>
                            </div>
                        </div>
                        <div class="row">
                            <div class="mb-3">
                                <textarea name="descripcion" cols="30" rows="5" class="form-control"
                                    placeholder="Descripción completa del riesgo (Sin saltos de linea)"></textarea>
                            </div>
                        </div>
                        <div class="row">
                            <div class="mb-3">
                                <label class="form-label">Tipo de Riesgo</label>
                                <select name="idTipoRiesgo" class="form-select">
                                    {% for tipoRiesgo in tiposRiesgo %}
                                    <option value="{{tipoRiesgo}}">{{tipoRiesgo}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <hr>
                            <h5 class="">Activo del riesgo</h5>

                            <!--Activos-->
                            <div class="mb-3">
                                <div class="row">
                                    <label class="form-label">Búsqueda por tipo</label>
                                    <div class="col-12 col-md-8">
                                        <!--Lista despegable-->
                                        <select id="tipoActivo" name="tipoActivo" class="form-select">
                                            <option selected>Selecciona un tipo</option>
                                            {% for tipo in tiposActivo %}
                                            <option value="{{tipo}}">{{tipo}}</option>
                                            {% endfor %}
                                        </select>
                                    </div>


                                    <div class="col-6 col-md-4">
                                        <button type="button" class="btn btn-dark bg-black ml-2" data-bs-toggle="modal"
                                            data-bs-target="#VentanaAddActivo">Añadir
                                            Activo</button>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">

                                <!-- Tabla en lugar de lista sin ordenar
                                    <table id="tabla-activos" class="table-responsive">
                                        <thead>
                                            <th>Seleccionar</th>
                                            <th></th>
                                        </thead>
                                        <tbody>
                                            {% for activo in activos %}
                                            <tr>
                                                <td><li class="list-group-item"><input type="checkbox" name="activos" value="{{ activo.id }}"> {{ activo.nombre }}</li></td>
                                                
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                    -->

                                <ul id="activosFilt" class="list-group list-group-flush">
                                    <!--
                                        <h6> Todos los activos del proyecto:</h6>
                                        {% for activo in activos %}
                                            <li class="list-group-item"><input type="checkbox" name="{{ activo.nombre }}" value="{{ activo.id }}"> <label for="{{ activo.nombre }}">{{ activo.nombre }}</label></li>
                                        {% endfor %}
                                        -->
                                </ul>

                            </div>

                            <div id="resultadosPre" class="mb-3">

                            </div>
                            <script>
                                $(document).ready(function () {
                                    var seleccionAnterior = [];

                                    function obtenerSeleccionesAnteriores() {
                                        var selecciones = [];
                                        $('#activosFilt input:checked').each(function () {
                                            selecciones.push($(this).val());
                                        });
                                        return selecciones;
                                    }


                                    function obtenerSelecciones(selecciones) {
                                        $('#activosFilt input:checked').each(function () {
                                            if (!selecciones.includes($(this).val())) {
                                                selecciones.push($(this).val());
                                            }
                                        });
                                        return selecciones;
                                    }

                                    $('#tipoActivo').change(function () {
                                        var tipo = $(this).val();
                                        if (seleccionAnterior.length == 0) {
                                            seleccionAnterior = obtenerSeleccionesAnteriores();
                                        } else {
                                            seleccionAnterior = obtenerSelecciones(seleccionAnterior);
                                        }

                                        $.ajax({
                                            type: 'POST',
                                            url: '/obtener-activos-json',
                                            contentType: 'application/json',
                                            data: JSON.stringify({ tipoActivo: tipo }),
                                            success: function (response) {
                                                // Inicializa el html interno de opciones
                                                var listarActivos = '';
                                                if (tipo != 'Selecciona un tipo') {
                                                    listarActivos += '<h6> Activos del tipo: ' + tipo + '</h6>';
                                                }
                                                $.each(response.activos, function (index, activo) {
                                                    // Tabla en lugar de lista sin ordenar
                                                    //var tr = document.createElement('tr');
                                                    //tr.innerHTML = '<td><li class="list-group-item"><input type="checkbox" name="activos" value="' + activo.id + '"> '+ activo.nombre + '</li></td>';
                                                    //tbody.appendChild(tr);
                                                    //var li = document.createElement('li');
                                                    //li.innerHTML = '<li class="list-group-item"><input type="checkbox" name="activos" value="' + activo.id + '"> '+ activo.nombre + '</li>';
                                                    //tbody.appendChild(li);
                                                    // Suma un li por cada activo en el tipo
                                                    // Verificar si el activo estaba seleccionado anteriormente

                                                    // Verificar si el activo estaba seleccionado anteriormente
                                                    var seleccionado = '';
                                                    if (seleccionAnterior.includes(activo.idActivo)) {
                                                        seleccionado = 'checked';
                                                    }

                                                    var color, sensibilidadNombre;
                                                    if (activo.sensibilidad > 18) {
                                                        color = 'btn-danger';
                                                        sensibilidadNombre = 'Sensibilidad alta';
                                                    } else if (activo.sensibilidad > 9) {
                                                        color = 'btn-warning';
                                                        sensibilidadNombre = 'Sensibilidad media';
                                                    } else {
                                                        color = 'btn-success';
                                                        sensibilidadNombre = 'Sensibilidad baja';
                                                    }
                                                    listarActivos += '<li class="list-group-item"><input type="checkbox" id="idActivos" name="idActivos"' + ' value="' + activo.idActivo + '" ' + seleccionado + '><label for="' + activo.idActivo + '"> ' + ' <span style="margin-right: 10px;"></span>' + activo.nombre +
                                                        ' <button type="button" class="btn btn-sm btn-block ' + color + '" style="pointer-events: none;">' + sensibilidadNombre + '</button></label></li>'
                                                });
                                                //resultados += '<h6>Resultados - Sensibilidad: A, Impacto: ' + umbralImpact + 'Probabilidad: ' + umbralProb +  'Riesgo total y activos: '+ riesgoTotal + activos_seleccionados + '<h6/>';
                                                // Renderiza en la lista activosFit el html que está en opciones
                                                $('#activosFilt').html(listarActivos);

                                            }
                                        });
                                    });
                                    // Mostrar alerta si ningún activo está seleccionado
                                    $('#formularioRiesgos').submit(function (event) {
                                        // Verificar si al menos un checkbox está marcado como seleccionado
                                        var alertaActivo = '';
                                        if (!$('#activosFilt input[type="checkbox"]:checked').length > 0) {
                                            // Mostrar un mensaje de error o tomar alguna acción
                                            alertaActivo = '<div class="alert alert-danger" role="alert">Selecciona al menos un activo para el riesgo. </div>';
                                            $('#activoRequerido').html(alertaActivo);
                                            // Prevenir el envío del formulario
                                            event.preventDefault();
                                        }
                                    });


                                    //Para previsualizar el riesgo antes del submit, no completado
                                    //function actualizarResultados() {
                                    //    // Probabilidad
                                    //    var p1 = parseInt($('[name=nivelHabilidad]').val());
                                    //    var p2 = parseInt($('[name=motivacion]').val());
                                    //    var p3 = parseInt($('[name=oportunidad]').val());
                                    //    var p4 = parseInt($('[name=tamaño]').val());
                                    //    var p5 = parseInt($('[name=facilidadDescubrimiento]').val());
                                    //    var p6 = parseInt($('[name=facilidadExplotacion]').val());
                                    //    var p7 = parseInt($('[name=conciencia]').val());
                                    //    var p8 = parseInt($('[name=deteccionIntrusiones]').val());
                                    //    var amenaza = (p1+p2+p3+p4)/4;
                                    //    var vulnerabilidad = (p5+p6+p7+p8)/4;
                                    //    var prob = (amenaza + vulnerabilidad)/2;
                                    //    // Impacto
                                    //    var i1 = parseInt($('[name=impactoFinanciero]').val());
                                    //    var i2 = parseInt($('[name=impactoReputacion]').val());
                                    //    var i3 = parseInt($('[name=impactoLegal]').val());
                                    //    var i4 = parseInt($('[name=impactoUsuario]').val());
                                    //    //var i5 = parseInt(activo.confidencialidad)
                                    //    //var i6 = parseInt(activo.disponibilidad)
                                    //    //var i7 = parseInt(activo.integridad)
                                    //    var empresarial = (i1+i2+i3+i4)/4;
                                    //    //var tecnico = (i5+i6+i7)/3;
                                    //    //var impact = (empresarial + tecnico)/2;
                                    //    var impact = empresarial/2;
                                    //    
                                    //    function umbral(factor){
                                    //        if(factor > 0 && factor < 3){
                                    //            return 'Bajo';
                                    //        }else if(factor >=3 && factor < 6){
                                    //            return 'Medio';
                                    //        }else if(factor >=6 && factor <=9){
                                    //            return 'Alto';
                                    //        }
                                    //    }
                                    //    var umbralProb = umbral(prob);
                                    //    var umbralImpact = umbral(impact);
                                    //    function total(umbralProb, umbralImpact){
                                    //        if (umbralImpact == 'Bajo' && umbralProb == 'Bajo'){
                                    //            return 'Insignificante';
                                    //        }else if(umbralImpact == 'Bajo' && umbralProb == 'Medio'){
                                    //            return 'Bajo';
                                    //        }else if(umbralImpact == 'Bajo' && umbralProb == 'Alto'){
                                    //            return 'Medio';
                                    //        }else if(umbralImpact == 'Medio' && umbralProb == 'Bajo'){
                                    //            return 'Bajo';
                                    //        }else if(umbralImpact == 'Medio' && umbralProb == 'Medio'){
                                    //            return 'Medio';
                                    //        }else if(umbralImpact == 'Medio' && umbralProb == 'Alto'){
                                    //            return 'Alto';
                                    //        }else if(umbralImpact == 'Alto' && umbralProb == 'Bajo'){
                                    //            return 'Medio';
                                    //        }else if(umbralImpact == 'Alto' && umbralProb == 'Medio'){
                                    //            return 'Alto';
                                    //        }else if(umbralImpact == 'Alto' && umbralProb == 'Alto'){
                                    //            return 'Crítico';
                                    //        }
                                    //    }
                                    //    var riesgoTotal = total(umbralProb, umbralImpact);
                                    //    var activos_seleccionados = $('#activosFilt').val();
                                    //    // Verificar si se han seleccionado todas las opciones necesarias
                                    //    
                                    //    // Calcular el máximo de las sensibilidades de los activos seleccionados
                                    //    var max_sensibilidad;
                                    //    $.each(activos_seleccionados, function(index, activo) {
                                    //        var sensibilidad = activo.sensibilidad; // Función para obtener la sensibilidad de un activo por su ID
                                    //        max_sensibilidad = Math.max(max_sensibilidad, sensibilidad);
                                    //    });
                                    //    // Actualizar los resultados en la página
                                    //    $('#resultadosPre').html('<p>Sensibilidad: ' + max_sensibilidad + '</p>' +
                                    //                                      '<p>Probabilidad: ' + umbralProb + '</p>' +
                                    //                                      '<p>Impacto: ' + umbralImpact + '</p>' +
                                    //                                      '<p>Riesgo total: ' + riesgoTotal + '</p>' +
                                    //                                      '<p>Máxima sensibilidad de los activos seleccionados: ' + '</p>');
                                    //    
                                    //}

                                    //$('#formularioRiesgos').change(actualizarResultados);
                                });
                            </script>

                        </div>
                        <hr>
                        <!-- Factores de probabilidad -->
                        <div class="row">
                            <div class="bg-body mb-3">
                                <h4 class="text-center ">Factores de probabilidad</h4>
                            </div>

                            <script>
                                $(function () {
                                    $('[data-toggle="tooltip"]').tooltip()
                                })
                            </script>




                            <!-- Factores de amenaza -->
                            <div class="">
                                <hr>
                                <h5 class="">Factores de amenaza</h5>

                                <!-- Agente de amenaza -->
                                <div class="row">
                                    <div class="mb-3">
                                        <label class="form-label">Agente de amenaza</label>
                                        <!--Lista despegable-->
                                        <select name="amenaza" class="form-select" style="white-space: pre-line;"
                                            required>
                                            {% for valor in agentes_amenaza %}
                                            <option value="{{valor}}">{{valor}}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <!--Nivel de habilidad-->

                                </div>
                                <div class="mb-3">
                                    <!--Titulo de valor y tooltip-->
                                    <label class="form-label">Nivel de habilidad</label>
                                    <i class="fa-solid fa-circle-info" data-toggle="tooltip" data-placement="top"
                                        title="Evalúa el nivel de habilidad técnica del grupo de amenazas que podría explotar el riesgo. Selecciona la opción que mejor describa las habilidades técnicas del posible atacante en función de la descripción proporcionada."></i>

                                    <!--Lista despegable-->
                                    <select name="nivelHabilidad" class="form-select" style="white-space: pre-line;"
                                        required>
                                        {% for valor, opcion in factores_de_amenaza['nivel_de_habilidad'].items() %}
                                        <option value="{{valor}}">{{valor}}: {{opcion}}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <!--Motivacion-->
                                <div class="mb-3">
                                    <!--Titulo de valor y tooltip-->
                                    <label class="form-label">Motivación</label>
                                    <i class="fa-solid fa-circle-info" data-toggle="tooltip" data-placement="top"
                                        title="Determina la motivación del posible atacante para explotar el riesgo. Considera el incentivo o la recompensa que podría impulsar al atacante a realizar el ataque y selecciona la opción que mejor se ajuste."></i>

                                    <!--Lista despegable-->
                                    <select name="motivacion" class="form-select" style="white-space: pre-line;"
                                        required>
                                        {% for valor, opcion in factores_de_amenaza['motivación'].items() %}
                                        <option value="{{valor}}">{{valor}}: {{opcion}}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <!--Oportunidad-->
                                <div class="mb-3">
                                    <!--Titulo de valor y tooltip-->
                                    <label class="form-label">Oportunidad</label>
                                    <i class="fa-solid fa-circle-info" data-toggle="tooltip" data-placement="top"
                                        title="Evalúa la disponibilidad de recursos y oportunidades para llevar a cabo un ataque exitoso. Selecciona la opción que describa mejor el acceso y los recursos disponibles para el atacante en función de la descripción proporcionada."></i>

                                    <!--Lista despegable-->
                                    <select name="oportunidad" class="form-select" style="white-space: pre-line;"
                                        required>
                                        {% for valor, opcion in factores_de_amenaza['oportunidad'].items() %}
                                        <option value="{{valor}}">{{valor}}: {{opcion}}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <!--Tamaño-->
                                <div class="mb-3">
                                    <!--Titulo de valor y tooltip-->
                                    <label class="form-label">Tamaño</label>
                                    <i class="fa-solid fa-circle-info" data-toggle="tooltip" data-placement="top"
                                        title="Determina el tamaño del grupo de amenazas que podría llevar a cabo el ataque. Considera el número de individuos involucrados en el ataque y selecciona la opción que mejor represente el tamaño del grupo de ataque según la descripción proporcionada."></i>

                                    <!--Lista despegable-->
                                    <select name="tamaño" class="form-select" style="white-space: pre-line;" required>
                                        {% for valor, opcion in factores_de_amenaza['tamaño'].items() %}
                                        <option value="{{valor}}">{{valor}}: {{opcion}}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>

                            <!-- Factores de vulnerabilidad -->
                            <div>
                                <hr>
                                <h5 class="">Factores de vulnerabilidad</h4>

                                    <!-- Vulnerabilidad -->
                                    <div class="row">
                                        <div class="mb-3">
                                            <input type="text" name="vulnerabilidad" class="form-control"
                                                placeholder="Vulnerabilidad" required autofocus>
                                        </div>
                                    </div>

                                    <!--Facilidad descubrimiento-->
                                    <div class="mb-3">
                                        <!--Titulo de valor y tooltip-->
                                        <label class="form-label">Facilidad de descubrimiento</label>
                                        <i class="fa-solid fa-circle-info" data-toggle="tooltip" data-placement="top"
                                            title="Evalúa la dificultad para descubrir la vulnerabilidad por parte de los atacantes. Selecciona la opción que mejor describa la probabilidad de que los atacantes descubran la vulnerabilidad según la descripción proporcionada."></i>

                                        <!--Lista despegable-->
                                        <select name="facilidadDescubrimiento" class="form-select"
                                            style="white-space: pre-line;" required>
                                            {% for valor, opcion in
                                            factores_de_vulnerabilidad['facilidad_de_descubrimiento'].items() %}
                                            <option value="{{valor}}">{{valor}}: {{opcion}}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <!--Facilidad de explotación-->
                                    <div class="mb-3">
                                        <!--Titulo de valor y tooltip-->
                                        <label class="form-label">Facilidad de explotación</label>
                                        <i class="fa-solid fa-circle-info" data-toggle="tooltip" data-placement="top"
                                            title="Determina la facilidad con la que los atacantes pueden explotar la vulnerabilidad una vez descubierta. Selecciona la opción que mejor describa la probabilidad de éxito de un ataque explotando la vulnerabilidad según la descripción proporcionada."></i>

                                        <!--Lista despegable-->
                                        <select name="facilidadExplotacion" class="form-select"
                                            style="white-space: pre-line;" required>
                                            {% for valor, opcion in
                                            factores_de_vulnerabilidad['facilidad_de_explotación'].items() %}
                                            <option value="{{valor}}">{{valor}}: {{opcion}}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <!--Conciencia-->
                                    <div class="mb-3">
                                        <!--Titulo de valor y tooltip-->
                                        <label class="form-label">Conciencia</label>
                                        <i class="fa-solid fa-circle-info" data-toggle="tooltip" data-placement="top"
                                            title="Evalúa el nivel de conocimiento de los atacantes sobre la vulnerabilidad. Selecciona la opción que mejor describa el grado de conocimiento de los atacantes sobre la vulnerabilidad según la descripción proporcionada."></i>

                                        <!--Lista despegable-->
                                        <select name="conciencia" class="form-select" style="white-space: pre-line;"
                                            required>
                                            {% for valor, opcion in factores_de_vulnerabilidad['conciencia'].items() %}
                                            <option value="{{valor}}">{{valor}}: {{opcion}}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <!--Detección de intrusiones-->
                                    <div class="mb-3">
                                        <!--Titulo de valor y tooltip-->
                                        <label class="form-label">Detección de intrusiones</label>
                                        <i class="fa-solid fa-circle-info" data-toggle="tooltip" data-placement="top"
                                            title="Determina la probabilidad de que un ataque sea detectado por sistemas de detección de intrusiones. Selecciona la opción que mejor describa la probabilidad de que un ataque sea detectado según la descripción proporcionada."></i>

                                        <!--Lista despegable-->
                                        <select name="deteccionIntrusiones" class="form-select"
                                            style="white-space: pre-line;" required>
                                            {% for valor, opcion in
                                            factores_de_vulnerabilidad['detección_de_intrusiones'].items() %}
                                            <option value="{{valor}}">{{valor}}: {{opcion}}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                            </div>
                        </div>

                        <!-- Factores de impacto -->
                        <div class="row">
                            <div class="bg-body mb-3">
                                <h4 class="text-center ">Factores de impacto</h4>
                            </div>

                            <!-- Impacto empresarial -->
                            <div class="">
                                <hr>
                                <h5 class="">Impacto empresarial</h5>

                                <!--Daño financiero-->
                                <div class="mb-3">
                                    <!--Titulo de valor y tooltip-->
                                    <label class="form-label">Daño financiero</label>
                                    <i class="fa-solid fa-circle-info" data-toggle="tooltip" data-placement="top"
                                        title="Evalúa el impacto financiero que podría tener la explotación del riesgo en la organización. Selecciona la opción que mejor describa el nivel de daño financiero potencial según la descripción proporcionada."></i>

                                    <!--Lista despegable-->
                                    <select name="impactoFinanciero" class="form-select" style="white-space: pre-line;"
                                        required>
                                        {% for valor, opcion in
                                        factores_de_impacto_empresarial['daño_financiero'].items()
                                        %}
                                        <option value="{{valor}}">{{valor}}: {{opcion}}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <!--Daño a la reputación-->
                                <div class="mb-3">
                                    <!--Titulo de valor y tooltip-->
                                    <label class="form-label">Daño a la reputación</label>
                                    <i class="fa-solid fa-circle-info" data-toggle="tooltip" data-placement="top"
                                        title="Determina el impacto que la explotación del riesgo podría tener en la reputación de la organización. Selecciona la opción que mejor describa el nivel de daño a la reputación potencial según la descripción proporcionada."></i>

                                    <!--Lista despegable-->
                                    <select name="impactoReputacion" class="form-select" style="white-space: pre-line;"
                                        required>
                                        {% for valor, opcion in
                                        factores_de_impacto_empresarial['daño_a_la_reputación'].items()
                                        %}
                                        <option value="{{valor}}">{{valor}}: {{opcion}}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <!--Incumplimiento-->
                                <div class="mb-3">
                                    <!--Titulo de valor y tooltip-->
                                    <label class="form-label">Incumplimiento legal</label>
                                    <i class="fa-solid fa-circle-info" data-toggle="tooltip" data-placement="top"
                                        title="Evalúa las consecuencias legales y regulatorias que podrían resultar de la explotación del riesgo. Selecciona la opción que mejor describa el nivel de incumplimiento potencial según la descripción proporcionada."></i>

                                    <!--Lista despegable-->
                                    <select name="impactoLegal" class="form-select" style="white-space: pre-line;"
                                        required>
                                        {% for valor, opcion in
                                        factores_de_impacto_empresarial['incumplimiento'].items() %}
                                        <option value="{{valor}}">{{valor}}: {{opcion}}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <!--Violación a la privacidad-->
                                <div class="mb-3">
                                    <!--Titulo de valor y tooltip-->
                                    <label class="form-label">Violación a la privacidad</label>
                                    <i class="fa-solid fa-circle-info" data-toggle="tooltip" data-placement="top"
                                        title="Determina el alcance de la divulgación de información personal que podría resultar de la explotación del riesgo. Selecciona la opción que mejor describa el nivel de violación de la privacidad potencial según la descripción proporcionada."></i>

                                    <!--Lista despegable-->
                                    <select name="impactoUsuarios" class="form-select" style="white-space: pre-line;"
                                        required>
                                        {% for valor, opcion in
                                        factores_de_impacto_empresarial['violación_de_la_privacidad'].items() %}
                                        <option value="{{valor}}">{{valor}}: {{opcion}}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="row">
                                <div class="mb-3">
                                    <button type="submit" class="btn btn-dark bg-black w-100">Registrar</button>
                                </div>
                            </div>
                            <div class="row">
                                <div id="activoRequerido" class="mb-3">

                                </div>
                            </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>




<!-- Modal para activos, Copypaste de modal de listarActivosl.html con modificación para regresar al modal de riesgos-->
<div class="row pt-2">
    <div class="modal fade" id="VentanaAddActivo" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
        aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Registrar Activo</h5>
                    <button type="button" class="btn ml-2" data-bs-toggle="modal" data-bs-target="#VentanaAddRiesgo"><i
                            class="fa-sharp fa-solid fa-backward"></i></button>
                </div>
                <div class="modal-body">
                    <form id="anadir-activo" method="post" autocomplete="off">
                        <div class="row">
                            <div class="mb-3">
                                <input type="text" name="clave" class="form-control" placeholder="Clave del Activo"
                                    required autofocus>
                            </div>
                        </div>
                        <div class="row">
                            <div class="mb-3">
                                <input type="text" name="nombre" class="form-control" placeholder="Nombre del activo"
                                    required autofocus>
                            </div>
                        </div>
                        <div class="row">
                            <div class="mb-3">
                                <textarea name="descripcion" cols="30" rows="5" class="form-control"
                                    placeholder="Descripción completa del activo(Sin saltos de linea)"></textarea>
                            </div>
                        </div>
                        <div class="row">
                            <div class="mb-3">
                                <input type="text" name="propietario" class="form-control"
                                    placeholder="Nombre del Propietario" required autofocus>
                            </div>
                        </div>
                        <div class="row">
                            <div class="mb-3">
                                <input type="text" name="ubicacion" class="form-control"
                                    placeholder="Ubicación Física/Lógica del activo" required autofocus>
                            </div>
                        </div>
                        <div class="row">
                            <div class="mb-3">
                                <label class="form-label">Tipo de Activo</label>
                                <select name="tipo" class="form-select" style="white-space: pre-line;" required>
                                    {% for opcion in tiposActivo %}
                                    <option value="{{opcion}}">{{opcion}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="mb-3">
                                <label class="form-label">Estatus</label>
                                <select name="estatus" class="form-select" style="white-space: pre-line;" required>
                                    {% for opcion in estatus %}
                                    <option value="{{opcion}}">{{opcion}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="mb-3">
                                <label class="form-label">Frecuencia de Mantenimiento</label>
                                <select name="frecM" class="form-select" style="white-space: pre-line;" required>
                                    {% for opcion in frecuencia %}
                                    <option value="{{opcion}}">{{opcion}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="mb-3">
                                <label class="form-label">Frecuencia de Renovación</label>
                                <select name="frecR" class="form-select" style="white-space: pre-line;" required>
                                    {% for opcion in frecuencia %}
                                    <option value="{{opcion}}">{{opcion}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="mb-3">
                                <label class="form-label">Fecha de Adquisición</label>
                                <input type="date" name="fecha" class="form-control">
                            </div>
                        </div>

                        <!-- Evaluación del activo, dentro del mismo formulario -->
                        <div class="mb-3">
                            <div class="bg-body mb-3">
                                <h4 class="text-center ">Evaluación del activo</h4>
                                <hr>
                            </div>
                            <div class="row">
                                <label class="form-label">Confidencialidad</label>
                            </div>
                            <div class="row">
                                <select name="confidencialidad" class="form-select" style="white-space: pre-line;"
                                    required>
                                    {% for valor, opcion in cdi['confidencialidad'].items() %}

                                    <option value="{{valor}}">{{valor}}: {{opcion}}</option>

                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="row">
                                <label class="form-label">Disponibilidad</label>
                            </div>
                            <div class="row">
                                <select name="disponibilidad" class="form-select" style="white-space: pre-line;"
                                    required>
                                    {% for valor, opcion in cdi['disponibilidad'].items() %}

                                    <option value="{{valor}}">{{valor}}: {{opcion}}</option>

                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="row">
                                <label class="form-label">Integridad</label>
                            </div>
                            <div class="row">
                                <select name="integridad" class="form-select" style="white-space: pre-line;" required>
                                    {% for valor, opcion in cdi['integridad'].items() %}

                                    <option value="{{valor}}">{{valor}}: {{opcion}}</option>

                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="row">
                            <div class="mb-3 pd-4   " id="resultadoActivo"></div>
                        </div>


                        <div class="row">
                            <div class="col-6 col-md-4">
                                <button type="button" class="btn btn-dark bg-black w-100 ml-2" data-bs-toggle="modal"
                                    data-bs-target="#VentanaAddRiesgo">
                                    <i class="fa-sharp fa-solid fa-backward"></i> Regresar al riesgo</button>
                            </div>
                            <div class="col-12 col-md-8">
                                <button type="submit" class="btn btn-dark bg-black w-100">Registrar activo</button>
                            </div>
                        </div>
                    </form>


                    <div>
                        {% with messages = get_flashed_messages() %}
                        {% if messages %}
                        <div class="row pt-5" id="alertRow">
                            <div class="alert alert-{{messages[0]}} alert-dismissible fade show" role="alert">
                                {{messages[1]}}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"
                                    id="closeAlert"></button>
                            </div>
                        </div>
                        {% endif %}
                        {% endwith %}
                    </div>


                    <!-- AJAX para añadir activo sin tener que redirigir a otra ruta-->
                    <!--Funciona, pero no maneja excepciones (flashes) dentro del modal, por alguna razón se van a la vista de acciones-->
                    <script>
                        document.getElementById("anadir-activo").addEventListener("submit", function (event) {
                            event.preventDefault(); // Evitar que el formulario se envíe normalmente

                            // Obtener los datos del formulario
                            var formData = new FormData(this);

                            // Enviar los datos del formulario usando AJAX
                            fetch('/anadir-activos-en-riesgo', {
                                method: 'POST',
                                body: formData
                            })
                                .then(response => {
                                    if (!response.ok) {
                                        throw new Error('Network response was not ok');
                                    }
                                    return response.text();
                                })
                                .then(data => {
                                    //console.log('Result:' + typeof(data)); // Manejar la respuesta del servidor
                                    if (data.includes('Existe')) {
                                        htmlMensaje = '<div class="alert alert-danger" role="alert">La clave del activo ya existe</div>';
                                    } else {
                                        htmlMensaje = '<div class="alert alert-success" role="alert">El activo ha sido añadido correctamente</div>';
                                    }

                                    $('#resultadoActivo').html(htmlMensaje);

                                })
                                .catch(error => {
                                    console.error('There was an error!', error);
                                });
                            // Manejar los mensajes flash después de enviar el formulario
                            // Puedes hacer esto mostrando mensajes flash en la página o realizando cualquier otra acción deseada
                            // Por ejemplo, puedes mostrar mensajes flash en una área específica de la página
                            //var flashMessages = document.getElementById("flash-messages");
                            //flashMessages.innerHTML = ""; // Limpiar mensajes flash anteriores


                        });
                    </script>

                </div>
            </div>
        </div>
    </div>
</div>





<div class="row pt-2">
    <div class="table-responsive">
        <table class="table table-main">
            <thead>
                <th>Clave</th>
                <th>Nombre</th>
                <th>Tipo</th>
                <th style="display: none;">Probabilidad</th>
                <th style="display: none;">Impacto</th>
                <th class="custom-sort">Umbral Total</th>
                <th>No. Acciones</th>
                <th>Funciones</th>
            </thead>
            <tbody>

                {% for clave in dictRiesgos.keys() %}
                <tr>
                    <td>{{ dictRiesgos[clave]['riesgo'].clave }}</td>
                    <td>{{ dictRiesgos[clave]['riesgo'].nombre }}</td>
                    <td>{{ dictRiesgos[clave]['riesgo'].tipoRiesgo}}</td>
                    <td style="display: none;">{{dictRiesgos[clave]['activos'][0][1]}}</td>
                    <td style="display: none;">{{dictRiesgos[clave]['activos'][0][2]}}</td>
                    {% if dictRiesgos[clave]['activos'][0][3] == 'Insignificante' %}
                    <td class="bg-info">{{ dictRiesgos[clave]['activos'][0][3] }}</td>
                    {% elif dictRiesgos[clave]['activos'][0][3] == 'Bajo' %}
                    <td class="bg-success">{{ dictRiesgos[clave]['activos'][0][3] }}</td>
                    {% elif dictRiesgos[clave]['activos'][0][3] == 'Medio' %}
                    <td style="background-color: rgb(255, 214, 31); color: black;">{{
                        dictRiesgos[clave]['activos'][0][3] }}</td>
                    {% elif dictRiesgos[clave]['activos'][0][3] == 'Alto' %}
                    <td style="background-color: rgb(255, 145, 0); color: black;">{{ dictRiesgos[clave]['activos'][0][3]
                        }}</td>
                    {% else %}
                    <td class="bg-danger">{{ dictRiesgos[clave]['activos'][0][3] }}</td>
                    {% endif %}
                    <td>
                        {% if dictRiesgos[clave]['riesgo'].acciones %}
                        {{dictRiesgos[clave]['riesgo'].acciones|length}}
                        {% else %}
                        Sin Acciones
                        {% endif %}
                    </td>
                    <td>
                        <button type="button" class="btn btn-light btn-more" data-bs-toggle="modal"
                            data-bs-target="#Ventana{{dictRiesgos[clave]['riesgo'].idRiesgo}}"><i
                                class="fa fa-eye"></i></button>
                        <a href="/modificar-riesgo/{{dictRiesgos[clave]['riesgo'].idRiesgo}}" class="btn btn-success"><i
                                class="fa fa-pencil"></i></a>
                        <a href="/listar-activos/{{dictRiesgos[clave]['riesgo'].idRiesgo}}" class="btn btn-warning"><i
                                class="fa fa-list"></i></a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% for clave in dictRiesgos.keys() %}
<div class="modal fade" id="Ventana{{dictRiesgos[clave]['riesgo'].idRiesgo}}" data-bs-backdrop="static"
    data-bs-keyboard="false" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalles del Riesgo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-justify">

                <p><b>Clave: </b>{{dictRiesgos[clave]['riesgo'].clave}}</p>
                <p><b>Nombre: </b>{{dictRiesgos[clave]['riesgo'].nombre}}</p>
                <p><b>Descripción: </b>{{dictRiesgos[clave]['riesgo'].descripcion}}</p>
                <p><b>Tipo de Riesgo: </b>{{dictRiesgos[clave]['riesgo'].tipoRiesgo}}</p>


                {% if dictRiesgos[clave]['activos'][0][1] == "Alto" %}
                <p><b>Probabilidad: </b><button type="button" class="btn btn-sm btn-block btn-danger"
                        style="pointer-events: none;"> Alta </button></p>
                {% elif dictRiesgos[clave]['activos'][0][1] == "Medio" %}
                <p><b>Probabilidad: </b><button type="button" class="btn btn-sm btn-block btn-warning"
                        style="pointer-events: none;"> Media </button></p>
                {% else %}
                <p><b>Probabilidad: </b><button type="button" class="btn btn-sm btn-block btn-success"
                        style="pointer-events: none;"> Baja </button></p>
                {% endif %}
                <h5 class="text-center"><b>Probabilidad - Factores de amenaza</b></h5>
                <p><b>Agente de amenaza:</b> {{ dictRiesgos[clave]['riesgo'].amenaza}}</p>
                <table class="table table-responsive">
                    <thead>
                        <th style="text-align: center;padding: 10px;">Nivel de habilidad</th>
                        <th style="text-align: center;padding: 10px;">Motivacion</th>
                        <th style="text-align: center;padding: 10px;">Oportunidad</th>
                        <th style="text-align: center;padding: 10px;">Tamaño</th>
                    </thead>
                    <tr>
                        <td class="" style="text-align: center;padding: 10px;"> {{
                            dictRiesgos[clave]['riesgo'].nivelHabilidad}}<br>{{factores_de_amenaza['nivel_de_habilidad'][dictRiesgos[clave]['riesgo'].nivelHabilidad]}}</td>
                        <td class="" style="text-align: center;padding: 10px;"> {{
                            dictRiesgos[clave]['riesgo'].motivacion}}<br>{{factores_de_amenaza['motivación'][dictRiesgos[clave]['riesgo'].motivacion]}}</td>
                        <td class="" style="text-align: center;padding: 10px;"> {{
                            dictRiesgos[clave]['riesgo'].oportunidad}}<br>{{factores_de_amenaza['oportunidad'][dictRiesgos[clave]['riesgo'].oportunidad]}}</td>
                        <td class="" style="text-align: center;padding: 10px;"> {{ dictRiesgos[clave]['riesgo'].tamaño}}<br>{{factores_de_amenaza['tamaño'][dictRiesgos[clave]['riesgo'].tamaño]}}</td>
                    </tr>
                </table>

                <h5 class="text-center"><b>Probabilidad - Factores de vulnerabilidad</b></h5>
                <p><b>Vulnerabilidad:</b> {{ dictRiesgos[clave]['riesgo'].vulnerabilidad}}</p>
                <table class="table table-responsive">
                    <thead>

                        <th style="text-align: center;padding: 10px;">Facilidad de descubrimiento</th>
                        <th style="text-align: center;padding: 10px;">Facilidad de explotación</th>
                        <th style="text-align: center;padding: 10px;">Conciencia</th>
                        <th style="text-align: center;padding: 10px;">Detección de intrusiones</th>
                    </thead>
                    <tr>
                        <td class="" style="text-align: center;padding: 10px;"> {{
                            dictRiesgos[clave]['riesgo'].facilidadDescubrimiento}}<br>{{factores_de_vulnerabilidad['facilidad_de_descubrimiento'][dictRiesgos[clave]['riesgo'].facilidadDescubrimiento]}}</td>
                        <td class="" style="text-align: center;padding: 10px;"> {{
                            dictRiesgos[clave]['riesgo'].facilidadExplotacion}}<br>{{factores_de_vulnerabilidad['facilidad_de_explotación'][dictRiesgos[clave]['riesgo'].facilidadExplotacion]}}</td>
                        <td class="" style="text-align: center;padding: 10px;"> {{
                            dictRiesgos[clave]['riesgo'].conciencia}}<br>{{factores_de_vulnerabilidad['conciencia'][dictRiesgos[clave]['riesgo'].conciencia]}}</td>
                        <td class="" style="text-align: center;padding: 10px;"> {{
                            dictRiesgos[clave]['riesgo'].deteccionIntrusiones}}<br>{{factores_de_vulnerabilidad['detección_de_intrusiones'][dictRiesgos[clave]['riesgo'].deteccionIntrusiones]}}</td>
                    </tr>
                </table>

                {% if dictRiesgos[clave]['activos'][0][2] == "Alto" %}
                <p><b>Impacto: </b><button type="button" class="btn btn-sm btn-block btn-danger"
                        style="pointer-events: none;"> Alto </button></p>
                {% elif dictRiesgos[clave]['activos'][0][2] == "Medio" %}
                <p><b>Impacto: </b><button type="button" class="btn btn-sm btn-block btn-warning"
                        style="pointer-events: none;"> Medio </button></p>
                {% else %}
                <p><b>Impacto: </b><button type="button" class="btn btn-sm btn-block btn-success"
                        style="pointer-events: none;"> Bajo </button></p>
                {% endif %}

                <h5 class="text-center"><b>Impacto - Impacto empresarial</b></h5>
                <table class="table table-responsive">
                    <thead>

                        <th style="text-align: center;padding: 10px;">Impacto Financiero</th>
                        <th style="text-align: center;padding: 10px;">Impacto Reputacion</th>
                        <th style="text-align: center;padding: 10px;">Impacto Legal</th>
                        <th style="text-align: center;padding: 10px;">Impacto Usuarios</th>
                    </thead>
                    <tr>
                        <td class="" style="text-align: center;padding: 10px;"> {{
                            dictRiesgos[clave]['riesgo'].impactoFinanciero}}<br>{{factores_de_impacto_empresarial['daño_financiero'][dictRiesgos[clave]['riesgo'].impactoFinanciero]}}</td>
                        <td class="" style="text-align: center;padding: 10px;"> {{
                            dictRiesgos[clave]['riesgo'].impactoReputacion}}<br>{{factores_de_impacto_empresarial['daño_a_la_reputación'][dictRiesgos[clave]['riesgo'].impactoReputacion]}}</td>
                        <td class="" style="text-align: center;padding: 10px;"> {{
                            dictRiesgos[clave]['riesgo'].impactoLegal}}<br>{{factores_de_impacto_empresarial['incumplimiento'][dictRiesgos[clave]['riesgo'].impactoLegal]}}</td>
                        <td class="" style="text-align: center;padding: 10px;"> {{
                            dictRiesgos[clave]['riesgo'].impactoUsuarios}}<br>{{factores_de_impacto_empresarial['violación_de_la_privacidad'][dictRiesgos[clave]['riesgo'].impactoUsuarios]}}</td>
                    </tr>
                </table>

                <h5 class="text-center"><b>Impacto - Impacto Técnico</b></h5>
                <p><b>Nota: </b>Se selecciona la asociación con el activo que produce el umbral de riesgo más elevado.</p>
                <p><b>{{dictRiesgos[clave]['activos'][0][0].clave}}</b> - {{dictRiesgos[clave]['activos'][0][0].nombre}}</p>
                <table class="table table-responsive">
                    <thead>
                        <th style="text-align: center;padding: 10px;">Confidencialidad</th>
                        <th style="text-align: center;padding: 10px;">Disponibilidad</th>
                        <th style="text-align: center;padding: 10px;">Integridad</th>
                        <th style="text-align: center;padding: 10px;">Sensibilidad</th>
                    </thead>
                    <tr>
                        <td class="" style="text-align: center;padding: 10px;">{{dictRiesgos[clave]['activos'][0][0].confidencialidad}}</td>
                        <td class="" style="text-align: center;padding: 10px;">{{dictRiesgos[clave]['activos'][0][0].disponibilidad}}</td>
                        <td class="" style="text-align: center;padding: 10px;">{{dictRiesgos[clave]['activos'][0][0].integridad}}</td>
                        <td class="" style="text-align: center;padding: 10px;">{{dictRiesgos[clave]['activos'][0][0].sensibilidad}}</td>
                    </tr>
                </table>

                {% if dictRiesgos[clave]['activos'][0][3] == "Crítico" %}
                <p><b>Umbral total: </b><button type="button" class="btn btn-sm btn-block btn-danger"
                        style="pointer-events: none;"> Crítico </button></p>
                {% elif dictRiesgos[clave]['activos'][0][3] == "Alto" %}
                <p><b>Umbral total: </b><button type="button" style="background-color: rgb(255, 145, 0); color: black;" class="btn btn-sm btn-block"
                        style="pointer-events: none;"> Alto </button></p>
                {% elif dictRiesgos[clave]['activos'][0][3] == "Medio" %}
                <p><b>Umbral total: </b><button type="button" class="btn btn-sm btn-block btn-warning"
                        style="pointer-events: none;"> Medio </button></p>
                {% else %}
                <p><b>Umbral total: </b><button type="button" class="btn btn-sm btn-block btn-success"
                        style="pointer-events: none;"> Bajo </button></p>
                {% endif %}

                <p><b>Activos asociados: </b></p>
                <table class="table">
                    <thead>
                        <th></th>
                        <th>Nombre</th>
                        <th>Clave</th>
                        <th>Sensibildad</th>
                    </thead>
                    <tbody>

                        {% for activo in dictRiesgos[clave]['activos'] %}
                        <tr>
                            <td><i class="fa-solid fa-circle-info" data-toggle="tooltip" data-placement="top"
                                    title="Descripción: {{activo[0].descripcion}}"></i></td>
                            <td class=""> {{ activo[0].nombre }}</td>
                            <td>{{ activo[0].clave }}</td>
                            <td>
                                {% if activo[0].sensibilidad > 18 %}
                                <button type="button" class="btn btn-sm btn-block btn-danger"
                                    style="pointer-events: none;"> Sensibilidad alta </button>
                                {% elif activo[0].sensibilidad > 9 %}
                                <button type="button" class="btn btn-sm btn-block btn-warning"
                                    style="pointer-events: none;"> Sensibilidad media </button>
                                {% else %}
                                <button type="button" class="btn btn-sm btn-block btn-success"
                                    style="pointer-events: none;"> Sensibilidad baja </button>
                                {% endif %}
                            </td>
                            </li>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>

                <p><b>Acciones del riesgo: </b></p>
                {% if dictRiesgos[clave]['riesgo'].acciones %}
                <table class="table">
                    <thead>
                        <th>Clave</th>
                        <th>Nombre</th>
                        <th>Fecha Inicio</th>
                        <th>Fecha Fin</th>
                        <th>Estado</th>
                        <th>Porcentaje</th>
                    </thead>
                    <tbody>
                        {% for accion in dictRiesgos[clave]['riesgo'].acciones %}
                        <tr>
                            <td>{{accion.clave}}</td>
                            <td>{{accion.nombre}}</td>
                            <td>{{accion.fechaIni}}</td>
                            <td>{{accion.fechaFin}}</td>
                            <td>{{accion.estado}}</td>
                            <td>{{accion.porcentaje}}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <button type="button" class="btn btn-danger w-100" style="pointer-events: none;"> A este riesgo aun no se le han asignado acciones </button>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endfor %}
<style>
    .table-main td {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
</style>
<script>
    $(document).ready(function () {
        var customSortType = $.fn.dataTable.ext.type.order['custom-sort'];
        var order = { 'Insignificante': 1, 'Bajo': 2, 'Medio': 3, 'Alto': 4, 'Crítico': 5 };

        $.fn.dataTable.ext.type.order['custom-sort-asc'] = function (a, b) {
            return order[a] - order[b];
        };

        $.fn.dataTable.ext.type.order['custom-sort-desc'] = function (a, b) {
            return order[b] - order[a];
        };

        var table = $('.table-main').DataTable({
            "scrollX": true,
            "lengthChange": false,
            "paging": false,
            "info": false,
            "language": {
                "search": "",  // Eliminar el texto "Buscar:"
                "searchPlaceholder": "Buscar Riesgo o Tipo",  // Establecer el marcador de posición
                "zeroRecords": "No se encontraron registros coincidentes"
            },
            "columnDefs": [
                {
                    "orderable": false, // Deshabilitar ordenamiento
                    "searchable": true, // Permitir búsqueda
                    "targets": [0,1,2,4] // Primera columna
                },
                {
                    "orderable": true,
                    "searchable": true, // Deshabilitar búsqueda
                    "targets": "custom-sort",
                    "type": "custom-sort" // Usar el tipo de datos personalizado para la ordenación
                },
                {
                    "orderable": false, // Deshabilitar ordenamiento
                    "searchable": false, // Deshabilitar búsqueda
                    "targets": [-1] // Última columna
                }
            ],
            dom: 'Bfrtip',
            buttons: [
                {
                    extend: 'print',
                    text: 'Vista previa de impresión',
                    title: 'Riesgos identificados en el Proyecto {{proyecto.nombre}}', // Cambia esto al título que desees
                    exportOptions: {
                        columns: ':not(:nth-child(8))' // Excluir la última columna
                    },
                    customize: function (win) {
                        $(win.document.body)
                            .css('font-size', '10pt')
                            .prepend(
                                '<style>' +
                                '@page { size: landscape; }' +
                                'table { border-collapse: collapse; width: 100%; }' +
                                'table, th, td { border: 1px solid black; }' +
                                'th, td { padding: 8px; text-align: left; }' +
                                '</style>'
                            );
                    },
                    init: function (api, node, config) {
                        $(node).css({
                            'background-color': 'black',
                            'color': 'white',
                            'border': 'none',
                            'padding': '6px 12px',
                            'margin': '5px',
                            'cursor': 'pointer'
                        }).hover(function () {
                            $(this).css('background-color', 'black');
                            $(this).css('color', 'white');
                        });
                    }
                }
            ]
        });

        $('#filter-tipo').on('change', function () {
            var tipo = $(this).val();
            table.column(2).search(tipo, true, false).draw();
        });

        $('#filter-umbral').on('change', function () {
            var umbral = $(this).val();
            table.column(5).search(umbral, true, false).draw();
        });

        $('#filter-accion').on('change', function () {
            var filtro = $(this).val();
            if(filtro == 'si'){
                table.column(6).search('\\d', true, false).draw();
            }
            else{
                table.column(6).search('Sin Acciones', true, false).draw();
            }
        });

        $('input[name="search"]').on('keyup', function () {
            table.search(this.value).draw();
        });

        $('.dataTables_filter').css('display', 'none')

    });
</script>

{% endblock %}
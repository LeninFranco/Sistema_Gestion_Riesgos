{% extends "templateSideBar.html" %}

{% block username %} {{usuario.nombre}} {% endblock %}

{% block content %}
{% with messages = get_flashed_messages() %}
{% if messages %}
<div class="row pt-5" id="alertRow">
    <div class="alert alert-{{messages[0]}} alert-dismissible fade show" role="alert">
        {{messages[1]}}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close" id="closeAlert"></button>
    </div>
</div>
{% endif %}
{% endwith %}



<div class="row pt-2">
    <h2>Riesgos</h2>
</div>
<div class="row pt-2">
    <div class="modal fade" id="VentanaAddRiesgo" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
        aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Registrar Riesgos</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form action="/anadir-riesgo" id="formularioRiesgos" method="post" autocomplete="off">
                        <div class="row">
                            <div class="mb-3">
                                <input type="text" name="clave" class="form-control" placeholder="Clave de identificación del riesgo"
                                    required autofocus>
                            </div>
                        </div>
                        <div class="row">
                            <div class="mb-3">
                                <input type="text" name="nombre" class="form-control" placeholder="Nombre del riesgo"
                                    required autofocus>
                            </div>
                        </div>
                        <div class="row">
                            <div class="mb-3">
                                <textarea name="descripcion" cols="30" rows="5" class="form-control"
                                    placeholder="Descripción completa del riesgo (Sin saltos de linea)"></textarea>
                            </div>
                        </div>
                        <div class="row">
                            <div class="mb-3">
                                <label class="form-label">Tipo de Riesgo</label>
                                <select name="idTipoRiesgo" class="form-select">
                                    {% for tipoRiesgo in tiposRiesgo %}
                                    <option value="{{tipoRiesgo.idTipoRiesgo}}">{{tipoRiesgo}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <!-- <div class="mb-3"> 
                                <label class="form-label">Selecciona el Activo (Su sensibilidad es el Impacto Técnico)
                                </label>
                                <select name="idActivo" class="form-select">
                                    {% for activo in activos %}
                                    <option value="{{activo.idActivo}}">{{activo.nombre}}</option>
                                    {% endfor %}
                                </select>
                            </div>  -->
                        </div>

                        <!-- Factores de probabilidad -->
                        <div class="row">
                            <div class="bg-body mb-3">
                                <h4 class="text-center ">Factores de probabilidad</h4>
                            </div>
                            
                                <script>
                                    $(function () {
                                      $('[data-toggle="tooltip"]').tooltip()
                                    })
                                </script>

                            <!-- Factores de amenaza -->    
                            <div class="">
                                <hr>
                                <h5 class="">Factores de amenaza</h5>
                                    <!--Nivel de habilidad-->
                                    <div class="mb-3">
                                        <!--Titulo de valor y tooltip-->
                                        <label class="form-label">Nivel de habilidad</label>
                                        <i class="fa-solid fa-circle-info" data-toggle="tooltip" data-placement="top" 
                                        title="¿Qué nivel técnico tiene este grupo de agentes de amenazas?"></i>
                                        
                                        <!--Lista despegable-->
                                        <select name="nivelHabilidad" class="form-select" style="white-space: pre-line;"
                                            required>
                                            {% for valor, opcion in factores_de_amenaza['nivel_de_habilidad'].items() %}
                                            <option value="{{valor}}">{{valor}}: {{opcion}}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <!--Motivacion-->
                                    <div class="mb-3">
                                        <!--Titulo de valor y tooltip-->
                                        <label class="form-label">Motivación</label>
                                        <i class="fa-solid fa-circle-info" data-toggle="tooltip" data-placement="top" 
                                        title="¿Qué motivación tiene este grupo de agentes de amenazas para encontrar y explotar esta vulnerabilidad?"></i>
                                        
                                        <!--Lista despegable-->
                                        <select name="motivacion" class="form-select" style="white-space: pre-line;" required>
                                            {% for valor, opcion in factores_de_amenaza['motivación'].items() %}
                                            <option value="{{valor}}">{{valor}}: {{opcion}}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <!--Oportunidad-->
                                    <div class="mb-3">
                                        <!--Titulo de valor y tooltip-->
                                        <label class="form-label">Oportunidad</label>
                                        <i class="fa-solid fa-circle-info" data-toggle="tooltip" data-placement="top" 
                                        title="¿Qué recursos y oportunidades necesita este grupo de agentes de amenazas para encontrar y explotar esta vulnerabilidad?"></i>
                                        
                                        <!--Lista despegable-->
                                        <select name="oportunidad" class="form-select" style="white-space: pre-line;" required>
                                            {% for valor, opcion in factores_de_amenaza['oportunidad'].items() %}
                                            <option value="{{valor}}">{{valor}}: {{opcion}}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <!--Tamaño-->
                                    <div class="mb-3">
                                        <!--Titulo de valor y tooltip-->
                                        <label class="form-label">Tamaño</label>
                                        <i class="fa-solid fa-circle-info" data-toggle="tooltip" data-placement="top" 
                                        title="¿Qué tamaño tiene este grupo de agentes de amenazas?"></i>
                                        
                                        <!--Lista despegable-->
                                        <select name="tamaño" class="form-select" style="white-space: pre-line;" required>
                                            {% for valor, opcion in factores_de_amenaza['tamaño'].items() %}
                                            <option value="{{valor}}">{{valor}}: {{opcion}}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                            </div>
                            
                            <!-- Factores de vulnerabilidad -->    
                            <div>
                                <hr>
                                <h5 class="">Factores de vulnerabilidad</h4>
                                    <!--Facilidad descubrimiento-->
                                    <div class="mb-3">
                                        <!--Titulo de valor y tooltip-->
                                        <label class="form-label">Facilidad de descubrimiento</label>
                                        <i class="fa-solid fa-circle-info" data-toggle="tooltip" data-placement="top" 
                                        title="¿Cómo de fácil es para este grupo de agentes de amenazas descubrir esta vulnerabilidad?"></i>
                                        
                                        <!--Lista despegable-->
                                        <select name="facilidadDescubrimiento" class="form-select" style="white-space: pre-line;" required>
                                            {% for valor, opcion in
                                            factores_de_vulnerabilidad['facilidad_de_descubrimiento'].items() %}
                                            <option value="{{valor}}">{{valor}}: {{opcion}}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <!--Facilidad de explotación-->
                                    <div class="mb-3">
                                        <!--Titulo de valor y tooltip-->
                                        <label class="form-label">Facilidad de explotación</label>
                                        <i class="fa-solid fa-circle-info" data-toggle="tooltip" data-placement="top" 
                                        title="¿Hasta qué punto es fácil para este grupo de agentes de amenazas explotar realmente esta vulnerabilidad?"></i>
                                        
                                        <!--Lista despegable-->
                                        <select name="facilidadExplotacion" class="form-select" style="white-space: pre-line;" required>
                                            {% for valor, opcion in factores_de_vulnerabilidad['facilidad_de_explotación'].items() %}
                                            <option value="{{valor}}">{{valor}}: {{opcion}}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <!--Conciencia-->
                                    <div class="mb-3">
                                        <!--Titulo de valor y tooltip-->
                                        <label class="form-label">Conciencia</label>
                                        <i class="fa-solid fa-circle-info" data-toggle="tooltip" data-placement="top" 
                                        title="¿Hasta qué punto es conocida esta vulnerabilidad por este grupo de agentes de amenazas?"></i>
                                        
                                        <!--Lista despegable-->
                                        <select name="conciencia" class="form-select" style="white-space: pre-line;" required>
                                            {% for valor, opcion in factores_de_vulnerabilidad['conciencia'].items() %}
                                            <option value="{{valor}}">{{valor}}: {{opcion}}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <!--Detección de intrusiones-->
                                    <div class="mb-3">
                                        <!--Titulo de valor y tooltip-->
                                        <label class="form-label">Detección de intrusiones</label>
                                        <i class="fa-solid fa-circle-info" data-toggle="tooltip" data-placement="top" 
                                        title="¿Qué probabilidades hay de que se detecte un exploit?"></i>
                                        
                                        <!--Lista despegable-->
                                        <select name="deteccionIntrusiones" class="form-select" style="white-space: pre-line;" required>
                                            {% for valor, opcion in factores_de_vulnerabilidad['detección_de_intrusiones'].items() %}
                                            <option value="{{valor}}">{{valor}}: {{opcion}}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                            </div>
                        </div>

                        <!-- Factores de impacto -->
                        <div class="row">
                            <div class="bg-body mb-3">
                                <h4 class="text-center ">Factores de impacto</h4>
                            </div>
                            
                            <!-- Factores de amenaza -->    
                            <div class="">
                                <hr>
                                <h5 class="">Impacto empresarial</h5>
                                    
                                    <!--Daño financiero-->
                                    <div class="mb-3">
                                        <!--Titulo de valor y tooltip-->
                                        <label class="form-label">Daño financiero</label>
                                        <i class="fa-solid fa-circle-info" data-toggle="tooltip" data-placement="top" 
                                        title="¿A cuánto ascienden los daños económicos derivados de un exploit?"></i>
                                        
                                        <!--Lista despegable-->
                                        <select name="impactoFinanciero" class="form-select" style="white-space: pre-line;"
                                            required>
                                            {% for valor, opcion in factores_de_impacto_empresarial['daño_financiero'].items()
                                            %}
                                            <option value="{{valor}}">{{valor}}: {{opcion}}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <!--Daño a la reputación-->
                                    <div class="mb-3">
                                        <!--Titulo de valor y tooltip-->
                                        <label class="form-label">Daño a la reputación</label>
                                        <i class="fa-solid fa-circle-info" data-toggle="tooltip" data-placement="top" 
                                        title="¿Supondría un exploit un daño para la reputación que perjudicaría a la empresa?"></i>
                                        
                                        <!--Lista despegable-->
                                        <select name="impactoReputacion" class="form-select" style="white-space: pre-line;"
                                            required>
                                            {% for valor, opcion in
                                            factores_de_impacto_empresarial['daño_a_la_reputación'].items()
                                            %}
                                            <option value="{{valor}}">{{valor}}: {{opcion}}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <!--Incumplimiento-->
                                    <div class="mb-3">
                                        <!--Titulo de valor y tooltip-->
                                        <label class="form-label">Incumplimiento legal</label>
                                        <i class="fa-solid fa-circle-info" data-toggle="tooltip" data-placement="top" 
                                        title="¿Qué grado de exposición introduce el incumplimiento?"></i>
                                        
                                        <!--Lista despegable-->
                                        <select name="impactoLegal" class="form-select" style="white-space: pre-line;" required>
                                            {% for valor, opcion in factores_de_impacto_empresarial['incumplimiento'].items() %}
                                            <option value="{{valor}}">{{valor}}: {{opcion}}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <!--Violación a la privacidad-->
                                    <div class="mb-3">
                                        <!--Titulo de valor y tooltip-->
                                        <label class="form-label">Violación a la privacidad</label>
                                        <i class="fa-solid fa-circle-info" data-toggle="tooltip" data-placement="top" 
                                        title="¿Cuánta información personal identificable podría divulgarse?"></i>
                                        
                                        <!--Lista despegable-->
                                        <select name="impactoUsuarios" class="form-select" style="white-space: pre-line;"
                                            required>
                                            {% for valor, opcion in
                                            factores_de_impacto_empresarial['violación_de_la_privacidad'].items() %}
                                            <option value="{{valor}}">{{valor}}: {{opcion}}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                            </div>
                            
                                                       
                            
                            <div class="row">
                                <hr>
                                <h5 class="">Activo del riesgo</h5>
                                    
                                    <!--Activos-->
                                    <div class="mb-3">
                                        <div class="row">
                                            <label class="form-label">Búsqueda por tipo</label>
                                            <div class="col-12 col-md-8">
                                                <!--Lista despegable-->
                                                <select id="tipoActivo" name="tipoActivo" class="form-select">
                                                    <option selected>Selecciona un tipo</option>
                                                    {% for tipo in tiposActivo %}
                                                    <option value="{{tipo}}">{{tipo}}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>


                                            <div class="col-6 col-md-4">
                                                <button type="button" class="btn btn-dark bg-black ml-2" data-bs-toggle="modal" data-bs-target="#VentanaAddActivo">Añadir Activo</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mb-3">

                                        <!-- Tabla en lugar de lista sin ordenar
                                        <table id="tabla-activos" class="table-responsive">
                                            <thead>
                                                <th>Seleccionar</th>
                                                <th></th>
                                            </thead>
                                            <tbody>
                                                {% for activo in activos %}
                                                <tr>
                                                    <td><li class="list-group-item"><input type="checkbox" name="activos" value="{{ activo.id }}"> {{ activo.nombre }}</li></td>
                                                    
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                        -->
                                        
                                        <ul id= "activosFilt" class="list-group list-group-flush">
                                            <!--
                                            <h6> Todos los activos del proyecto:</h6>
                                            {% for activo in activos %}
                                                <li class="list-group-item"><input type="checkbox" name="{{ activo.nombre }}" value="{{ activo.id }}"> <label for="{{ activo.nombre }}">{{ activo.nombre }}</label></li>
                                            {% endfor %}
                                            -->
                                        </ul>
                                        
                                    </div>
                                    
                                    <div id="resultadosPre" class="mb-3">
                                        
                                    </div>
                                    <script>
                                        $(document).ready(function() {
                                            var seleccionAnterior = [];

                                            function obtenerSeleccionesAnteriores() {
                                                var selecciones = [];
                                                $('#activosFilt input[type="checkbox"]:checked').each(function() {
                                                    selecciones.push($(this).val());
                                                });
                                                return selecciones;
                                            }
                                            $('#tipoActivo').change(function() {
                                                var tipo = $(this).val(); 
                                                seleccionAnterior = obtenerSeleccionesAnteriores();
                                                $.ajax({
                                                    type: 'POST',
                                                    url: '/obtener-activos-json',
                                                    contentType: 'application/json',
                                                    data: JSON.stringify({tipoActivo: tipo}),
                                                    success: function(response) {
                                                        // Inicializa el html interno de opciones
                                                        var listarActivos = '';
                                                        if(tipo != 'Selecciona un tipo'){
                                                            listarActivos += '<h6> Activos del tipo: '+ tipo + '</h6>';
                                                        }                                                     
                                                        // Tabla en lugar de lista sin ordenar
                                                        //var tbody = document.querySelector('#tabla-activos tbody');
                                                        //tbody.innerHTML = '';
                                                        $.each(response.activos, function(index, activo) {
                                                            // Tabla en lugar de lista sin ordenar
                                                            //var tr = document.createElement('tr');
                                                            //tr.innerHTML = '<td><li class="list-group-item"><input type="checkbox" name="activos" value="' + activo.id + '"> '+ activo.nombre + '</li></td>';
                                                            //tbody.appendChild(tr);
                                                            //var li = document.createElement('li');
                                                            //li.innerHTML = '<li class="list-group-item"><input type="checkbox" name="activos" value="' + activo.id + '"> '+ activo.nombre + '</li>';
                                                            //tbody.appendChild(li);
                                                            // Suma un li por cada activo en el tipo
                                                            // Verificar si el activo estaba seleccionado anteriormente
                                                                 
                                                            // Verificar si el activo estaba seleccionado anteriormente
                                                            var seleccionado = '';
                                                            if (seleccionAnterior.includes(activo.idActivo)){
                                                                seleccionado = 'checked';
                                                            }
                                                            //seleccionAnterior.includes(activo.idActivo) ? 'checked' : '';
                                                            var color, sensibilidadNombre;
                                                            if(activo.sensibilidad > 18){
                                                                color = 'btn-danger';
                                                                sensibilidadNombre = 'Sensibilidad alta';
                                                            }else if(activo.sensibilidad > 9){
                                                                color = 'btn-warning';
                                                                sensibilidadNombre = 'Sensibilidad media';
                                                            }else{
                                                                color = 'btn-success';
                                                                sensibilidadNombre = 'Sensibilidad baja';   
                                                            }
                                                            console.log('Selección: ' + seleccionado.toString());
                                                            listarActivos += '<li class="list-group-item"><input type="checkbox" name="'+ activo.idActivo + '" value="' + activo.idActivo + '"' + seleccionado + '><label for="' + activo.idActivo + '"> ' + ' '+ activo.nombre + 
                                                                ' <button type="button" class="btn btn-sm btn-block '+ color + '" style="pointer-events: none;">'+ sensibilidadNombre +'</button></label></li>'
                                                        });
                                                        //resultados += '<h6>Resultados - Sensibilidad: A, Impacto: ' + umbralImpact + 'Probabilidad: ' + umbralProb +  'Riesgo total y activos: '+ riesgoTotal + activos_seleccionados + '<h6/>';
                                                        // Renderiza en la lista activosFit el html que está en opciones
                                                        $('#activosFilt').html(listarActivos);

                                                    }
                                                });
                                            });

                                            
                                        
                                        //Para previsualizar el riesgo antes del submit
                                        //function actualizarResultados() {
                                        //    // Probabilidad
                                        //    var p1 = parseInt($('[name=nivelHabilidad]').val());
                                        //    var p2 = parseInt($('[name=motivacion]').val());
                                        //    var p3 = parseInt($('[name=oportunidad]').val());
                                        //    var p4 = parseInt($('[name=tamaño]').val());
                                        //    var p5 = parseInt($('[name=facilidadDescubrimiento]').val());
                                        //    var p6 = parseInt($('[name=facilidadExplotacion]').val());
                                        //    var p7 = parseInt($('[name=conciencia]').val());
                                        //    var p8 = parseInt($('[name=deteccionIntrusiones]').val());
                                        //    var amenaza = (p1+p2+p3+p4)/4;
                                        //    var vulnerabilidad = (p5+p6+p7+p8)/4;
                                        //    var prob = (amenaza + vulnerabilidad)/2;
                                        //    // Impacto
                                        //    var i1 = parseInt($('[name=impactoFinanciero]').val());
                                        //    var i2 = parseInt($('[name=impactoReputacion]').val());
                                        //    var i3 = parseInt($('[name=impactoLegal]').val());
                                        //    var i4 = parseInt($('[name=impactoUsuario]').val());
                                        //    //var i5 = parseInt(activo.confidencialidad)
                                        //    //var i6 = parseInt(activo.disponibilidad)
                                        //    //var i7 = parseInt(activo.integridad)
                                        //    var empresarial = (i1+i2+i3+i4)/4;
                                        //    //var tecnico = (i5+i6+i7)/3;
                                        //    //var impact = (empresarial + tecnico)/2;
                                        //    var impact = empresarial/2;
                                        //    
                                        //    function umbral(factor){
                                        //        if(factor > 0 && factor < 3){
                                        //            return 'Bajo';
                                        //        }else if(factor >=3 && factor < 6){
                                        //            return 'Medio';
                                        //        }else if(factor >=6 && factor <=9){
                                        //            return 'Alto';
                                        //        }
                                        //    }
                                        //    var umbralProb = umbral(prob);
                                        //    var umbralImpact = umbral(impact);
                                        //    function total(umbralProb, umbralImpact){
                                        //        if (umbralImpact == 'Bajo' && umbralProb == 'Bajo'){
                                        //            return 'Insignificante';
                                        //        }else if(umbralImpact == 'Bajo' && umbralProb == 'Medio'){
                                        //            return 'Bajo';
                                        //        }else if(umbralImpact == 'Bajo' && umbralProb == 'Alto'){
                                        //            return 'Medio';
                                        //        }else if(umbralImpact == 'Medio' && umbralProb == 'Bajo'){
                                        //            return 'Bajo';
                                        //        }else if(umbralImpact == 'Medio' && umbralProb == 'Medio'){
                                        //            return 'Medio';
                                        //        }else if(umbralImpact == 'Medio' && umbralProb == 'Alto'){
                                        //            return 'Alto';
                                        //        }else if(umbralImpact == 'Alto' && umbralProb == 'Bajo'){
                                        //            return 'Medio';
                                        //        }else if(umbralImpact == 'Alto' && umbralProb == 'Medio'){
                                        //            return 'Alto';
                                        //        }else if(umbralImpact == 'Alto' && umbralProb == 'Alto'){
                                        //            return 'Crítico';
                                        //        }
                                        //    }
                                        //    var riesgoTotal = total(umbralProb, umbralImpact);
                                        //    var activos_seleccionados = $('#activosFilt').val();
                                        //    // Verificar si se han seleccionado todas las opciones necesarias
                                        //    
                                        //    // Calcular el máximo de las sensibilidades de los activos seleccionados
                                        //    var max_sensibilidad;
                                        //    $.each(activos_seleccionados, function(index, activo) {
                                        //        var sensibilidad = activo.sensibilidad; // Función para obtener la sensibilidad de un activo por su ID
                                        //        max_sensibilidad = Math.max(max_sensibilidad, sensibilidad);
                                        //    });
                                        //    // Actualizar los resultados en la página
                                        //    $('#resultadosPre').html('<p>Sensibilidad: ' + max_sensibilidad + '</p>' +
                                        //                                      '<p>Probabilidad: ' + umbralProb + '</p>' +
                                        //                                      '<p>Impacto: ' + umbralImpact + '</p>' +
                                        //                                      '<p>Riesgo total: ' + riesgoTotal + '</p>' +
                                        //                                      '<p>Máxima sensibilidad de los activos seleccionados: ' + '</p>');
                                        //    
                                        //}

                                        //$('#formularioRiesgos').change(actualizarResultados);

                                        

                                        });

                                    </script>
                                                                        
                            </div>

                        <!--
                        <div class="row">
                            <div class="col-6 mb-3">
                                <h3>Factores de Probabilidad</h3>
                            </div>
                            <div class="col-6 mb-3">
                                <h3>Factores de Impacto</h3>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-6 mb-3">
                                <h5>Agente de Amenaza</h5>
                            </div>
                            <div class="col-6 mb-3">
                                <h5>Impacto Técnico</h5>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-6 mb-3">
                                <input type="text" name="amenaza" class="form-control"
                                    placeholder="Nombre del agente de amenaza" required>
                            </div>
                            <div class="col-6 mb-3 text-justify" style="position: absolute; left: 50%; overflow: auto;">
                                <p>La sensibilidad del activo que se desea asociar a este riesgo está compuesta por tres
                                    variables que definen el impacto técnico del riesgo. </p>

                                <p>La primera variable se refiere a la confidencialidad de la información. Esto implica
                                    proteger la privacidad y la confidencialidad de los datos y asegurarse de que solo
                                    las personas autorizadas tengan acceso a la información crítica.</p>

                                <p>La segunda variable aborda la disponibilidad del activo. La disponibilidad se refiere
                                    a la capacidad de acceder y utilizar los recursos de manera ininterrumpida. </p>

                                <p>La tercera variable se relaciona con la integridad de la información. La integridad
                                    implica garantizar que los datos no se modifiquen de manera no autorizada o
                                    inapropiada. </p>

                                <p>Si no encuentra el activo deseado en este momento, le
                                    recomendamos regresar al menú
                                    de activos para darlo de alta y asegurarse de que se incluya en la evaluación de
                                    riesgos de seguridad de la información.</p>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-6 mb-3">
                                <label class="form-label">Nivel de Habilidad</label>
                                <select name="nivelHabilidad" class="form-select" style="white-space: pre-line;"
                                    required>
                                    {% for valor, opcion in factores_de_amenaza['nivel_de_habilidad'].items() %}
                                    <option value="{{valor}}">{{valor}}: {{opcion}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-6 mb-3">
                                <label class="form-label">Motivación</label>
                                <select name="motivacion" class="form-select" style="white-space: pre-line;" required>
                                    {% for valor, opcion in factores_de_amenaza['motivación'].items() %}
                                    <option value="{{valor}}">{{valor}}: {{opcion}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-6 mb-3">
                                <label class="form-label">Oportunidad</label>
                                <select name="oportunidad" class="form-select" style="white-space: pre-line;" required>
                                    {% for valor, opcion in factores_de_amenaza['oportunidad'].items() %}
                                    <option value="{{valor}}">{{valor}}: {{opcion}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-6 mb-3">
                                <label class="form-label">Tamaño</label>
                                <select name="tamaño" class="form-select" style="white-space: pre-line;" required>
                                    {% for valor, opcion in factores_de_amenaza['tamaño'].items() %}
                                    <option value="{{valor}}">{{valor}}: {{opcion}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-6 mb-3">
                                <h5>Vulnerabilidad del Activo</h5>
                            </div>
                            <div class="col-6 mb-3">
                                <h5>Impacto Empresarial</h5>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-6 mb-3">
                                <input type="text" name="vulnerabilidad" class="form-control"
                                    placeholder="Nombre de la vulnerabilidad del activo" required>
                            </div>
                            <div class="col-6 mb-3">
                                <label class="form-label">
                                    Evalúe el impacto empresarial considerando aspectos económicos, legales y la
                                    privacidad
                                    del usuario.</label>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-6 mb-3">
                                <label class="form-label">Facilidad de Descubrimiento</label>
                                <select name="facilidadDescubrimiento" class="form-select"
                                    style="white-space: pre-line;" required>
                                    {% for valor, opcion in
                                    factores_de_vulnerabilidad['facilidad_de_descubrimiento'].items()
                                    %}
                                    <option value="{{valor}}">{{valor}}: {{opcion}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-6 mb-3">
                                <label class="form-label">Daño Financiero</label>
                                <select name="impactoFinanciero" class="form-select" style="white-space: pre-line;"
                                    required>
                                    {% for valor, opcion in factores_de_impacto_empresarial['daño_financiero'].items()
                                    %}
                                    <option value="{{valor}}">{{valor}}: {{opcion}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-6 mb-3">
                                <label class="form-label">Facilidad de Explotación</label>
                                <select name="facilidadExplotacion" class="form-select" style="white-space: pre-line;"
                                    required>
                                    {% for valor, opcion in
                                    factores_de_vulnerabilidad['facilidad_de_explotación'].items()
                                    %}
                                    <option value="{{valor}}">{{valor}}: {{opcion}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-6 mb-3">
                                <label class="form-label">Daño a la Reputación</label>
                                <select name="impactoReputacion" class="form-select" style="white-space: pre-line;"
                                    required>
                                    {% for valor, opcion in
                                    factores_de_impacto_empresarial['daño_a_la_reputación'].items()
                                    %}
                                    <option value="{{valor}}">{{valor}}: {{opcion}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-6 mb-3">
                                <label class="form-label">Conciencia</label>
                                <select name="conciencia" class="form-select" style="white-space: pre-line;" required>
                                    {% for valor, opcion in factores_de_vulnerabilidad['conciencia'].items() %}
                                    <option value="{{valor}}">{{valor}}: {{opcion}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-6 mb-3">
                                <label class="form-label">Incumplimiento Legal</label>
                                <select name="impactoLegal" class="form-select" style="white-space: pre-line;" required>
                                    {% for valor, opcion in factores_de_impacto_empresarial['incumplimiento'].items() %}
                                    <option value="{{valor}}">{{valor}}: {{opcion}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-6 mb-3">
                                <label class="form-label">Detección de Intrusiones</label>
                                <select name="deteccionIntrusiones" class="form-select" style="white-space: pre-line;"
                                    required>
                                    {% for valor, opcion in
                                    factores_de_vulnerabilidad['detección_de_intrusiones'].items() %}
                                    <option value="{{valor}}">{{valor}}: {{opcion}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-6 mb-3">
                                <label class="form-label">Violación de la Privacidad</label>
                                <select name="impactoUsuarios" class="form-select" style="white-space: pre-line;"
                                    required>
                                    {% for valor, opcion in
                                    factores_de_impacto_empresarial['violación_de_la_privacidad'].items() %}
                                    <option value="{{valor}}">{{valor}}: {{opcion}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        -->
                        
                        <div class="row">
                            <div class="mb-3">
                                <button type="submit" class="btn btn-dark bg-black w-100">Registrar</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>




<!-- Modal para activos, Copypaste de modal de listarActivosl.html con modificación para regresar al modal de riesgos-->
<div class="row pt-2">
    <div class="modal fade" id="VentanaAddActivo" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
        aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Registrar Activo</h5>
                    <button type="button" class="btn ml-2" data-bs-toggle="modal" data-bs-target="#VentanaAddRiesgo"><i class="fa-sharp fa-solid fa-backward"></i></button>
                </div>
                <div class="modal-body">
                    <form id="anadir-activo" method="post" autocomplete="off">
                        <div class="row">
                            <div class="mb-3">
                                <input type="text" name="clave" class="form-control" placeholder="Clave del Activo"
                                    required autofocus>
                            </div>
                        </div>
                        <div class="row">
                            <div class="mb-3">
                                <input type="text" name="nombre" class="form-control" placeholder="Nombre del activo"
                                    required autofocus>
                            </div>
                        </div>
                        <div class="row">
                            <div class="mb-3">
                                <textarea name="descripcion" cols="30" rows="5" class="form-control"
                                    placeholder="Descripción completa del activo(Sin saltos de linea)"></textarea>
                            </div>
                        </div>
                        <div class="row">
                            <div class="mb-3">
                                <input type="text" name="propietario" class="form-control"
                                    placeholder="Nombre del Propietario" required autofocus>
                            </div>
                        </div>
                        <div class="row">
                            <div class="mb-3">
                                <input type="text" name="ubicacion" class="form-control"
                                    placeholder="Ubicación Física/Lógica del activo" required autofocus>
                            </div>
                        </div>
                        <div class="row">
                            <div class="mb-3">
                                <label class="form-label">Tipo de Activo</label>
                                <select name="tipo" class="form-select" style="white-space: pre-line;" required>
                                    {% for opcion in tiposActivo %}
                                    <option value="{{opcion}}">{{opcion}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="mb-3">
                                <label class="form-label">Estatus</label>
                                <select name="estatus" class="form-select" style="white-space: pre-line;" required>
                                    {% for opcion in estatus %}
                                    <option value="{{opcion}}">{{opcion}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="mb-3">
                                <label class="form-label">Frecuencia de Mantenimiento</label>
                                <select name="frecM" class="form-select" style="white-space: pre-line;" required>
                                    {% for opcion in frecuencia %}
                                    <option value="{{opcion}}">{{opcion}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="mb-3">
                                <label class="form-label">Frecuencia de Renovación</label>
                                <select name="frecR" class="form-select" style="white-space: pre-line;" required>
                                    {% for opcion in frecuencia %}
                                    <option value="{{opcion}}">{{opcion}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="mb-3">
                                <label class="form-label">Fecha de Adquisición</label>
                                <input type="date" name="fecha" class="form-control">
                            </div>
                        </div>

                        <!-- Evaluación del activo, dentro del mismo formulario -->
                        <div class="mb-3">
                            <div class="bg-body mb-3">
                                <h4 class="text-center ">Evaluación del activo</h4>
                                <hr>
                            </div>
                            <div class="row">
                                <label class="form-label">Confidencialidad</label>
                            </div>
                            <div class="row">
                                <select name="confidencialidad" class="form-select" style="white-space: pre-line;" required>
                                    {% for valor, opcion in cdi['confidencialidad'].items() %}
                                    
                                    <option value="{{valor}}">{{valor}}: {{opcion}}</option>
                                    
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="row">
                                <label class="form-label">Disponibilidad</label>
                            </div>
                            <div class="row">
                                <select name="disponibilidad" class="form-select" style="white-space: pre-line;" required>
                                    {% for valor, opcion in cdi['disponibilidad'].items() %}
                                    
                                    <option value="{{valor}}">{{valor}}: {{opcion}}</option>
                                    
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="row">
                                <label class="form-label">Integridad</label>
                            </div>
                            <div class="row">
                                <select name="integridad" class="form-select" style="white-space: pre-line;" required>
                                    {% for valor, opcion in cdi['integridad'].items() %}
                                    
                                    <option value="{{valor}}">{{valor}}: {{opcion}}</option>
                                    
                                    {% endfor %}
                                </select>
                            </div>
                        </div>


                        <div class="row">
                            <div class="col-6 col-md-4">
                                <button type="button" class="btn btn-dark bg-black w-100 ml-2" data-bs-toggle="modal" data-bs-target="#VentanaAddRiesgo">
                                    <i class="fa-sharp fa-solid fa-backward"></i> Regresar al riesgo</button>
                            </div>
                            <div class="col-12 col-md-8">
                                <button type="submit" class="btn btn-dark bg-black w-100">Registrar activo</button>
                            </div>
                        </div>
                    </form>
                    

                    <div>
                        {% with messages = get_flashed_messages() %}
                            {% if messages %}
                            <div class="row pt-5" id="alertRow">
                                <div class="alert alert-{{messages[0]}} alert-dismissible fade show" role="alert">
                                    {{messages[1]}}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close" id="closeAlert"></button>
                                </div>
                            </div>
                            {% endif %}
                        {% endwith %}
                    </div>


                    <!-- AJAX para añadir activo sin tener que redirigir a otra ruta-->
                    <!--Funciona, pero no maneja excepciones (flashes) dentro del modal, por alguna razón se van a la vista de acciones-->
                    <script>
                        document.getElementById("anadir-activo").addEventListener("submit", function(event) {
                            event.preventDefault(); // Evitar que el formulario se envíe normalmente
                
                            // Obtener los datos del formulario
                            var formData = new FormData(this);
                
                            // Enviar los datos del formulario usando AJAX
                            fetch('/anadir-activos-en-riesgo', {
                                method: 'POST',
                                body: formData
                            })
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error('Network response was not ok');
                                }
                                return response.text();
                            })
                            .then(data => {
                                console.log('Result:' + data); // Manejar la respuesta del servidor
                                // Puedes actualizar la interfaz de usuario aquí si es necesario

                            
                            })
                            .catch(error => {
                                console.error('There was an error!', error);
                            });
                            // Manejar los mensajes flash después de enviar el formulario
                            // Puedes hacer esto mostrando mensajes flash en la página o realizando cualquier otra acción deseada
                            // Por ejemplo, puedes mostrar mensajes flash en una área específica de la página
                            //var flashMessages = document.getElementById("flash-messages");
                            //flashMessages.innerHTML = ""; // Limpiar mensajes flash anteriores

                            
                        });
                    </script>
                    
                </div>
            </div>
        </div>
    </div>
</div>





<div class="row pt-2">
    <div class="table-responsive">
        <table class="table">
            <thead>
                <th>Clave</th>
                <th>Nombre</th>
                <th>Tipo</th>
                <th class="custom-sort">Umbral Total</th>
                <th>Acciones</th>
            </thead>
            <tbody>
                {% for riesgo in riesgos_umbrales %}
                <tr>
                    <td>{{ riesgo[0].clave }}</td>
                    <td>{{ riesgo[0].nombre }}</td>
                    <td>{{riesgo[0].tipoRiesgo.nombre}}</td>
                    {% if riesgo[0].umbral == 'Insignificante' %}
                    <td style="background-color: blue;">{{ riesgo[0].umbral }}</td>
                    {% elif riesgo[0].umbral == 'Bajo' %}
                    <td style="background-color: green;">{{ riesgo[1] }}</td>
                    {% elif riesgo[0].umbral == 'Medio' %}
                    <td style="background-color: yellow; color: black;">{{ riesgo[0].umbral }}</td>
                    {% elif riesgo[0].umbral == 'Alto' %}
                    <td style="background-color: orange; color: black;">{{ riesgo[0].umbral }}</td>
                    {% else %}
                    <td style="background-color: red;">{{ riesgo[0].umbral }}</td>
                    {% endif %}
                    <td>
                        <button type="button" class="btn btn-light btn-more" data-bs-toggle="modal"
                            data-bs-target="#Ventana{{riesgo[0].idRiesgo}}"><i class="fa fa-plus"></i></button>
                        <a href="/modificar-riesgo/{{riesgo[0].idRiesgo}}" class="btn btn-success"><i
                                class="fa fa-pencil"></i></a>
                        <a href="/eliminar-riesgo/{{riesgo[0].idRiesgo}}" class="btn btn-danger btn-delete"><i
                                class="fa fa-trash"></i></a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% for riesgo in riesgos_umbrales %}
<div class="modal fade" id="Ventana{{riesgo[0].idRiesgo}}" data-bs-backdrop="static" data-bs-keyboard="false"
    tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalles del Riesgo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-justify">
                <p><b>Descripción: </b>{{riesgo[0].descripcion}}</p>
                <p><b>Tipo de Riesgo: </b>{{riesgo[0].tipoRiesgo.nombre}}</p>
                <p><b>Probabilidad: </b>{{umbrales['Probabilidad'][riesgo[1]]}}</p>
                <p><b>Impacto: </b>{{umbrales['Impacto'][riesgo[2]]}}</p>
                <p><b>Umbral Total: </b>{{umbrales['Umbral Total'][riesgo[0].umbral]}}</p>
                <p><b>Nombre del Activo asociado: </b>{{riesgo[0].activo.nombre}}</p>
            </div>
        </div>
    </div>
</div>
{% endfor %}
<script>
    $(document).ready(function () {
        var customSortType = $.fn.dataTable.ext.type.order['custom-sort'];
        var order = { 'Insignificante': 1, 'Bajo': 2, 'Medio': 3, 'Alto': 4, 'Crítico': 5 };

        $.fn.dataTable.ext.type.order['custom-sort-asc'] = function (a, b) {
            return order[a] - order[b];
        };

        $.fn.dataTable.ext.type.order['custom-sort-desc'] = function (a, b) {
            return order[b] - order[a];
        };

        $('.table').DataTable({
            "lengthChange": false,
            "paging": false,
            "info": false,
            "language": {
                "search": "",  // Eliminar el texto "Buscar:"
                "searchPlaceholder": "Buscar Riesgo o Tipo",  // Establecer el marcador de posición
                "zeroRecords": "No se encontraron registros coincidentes"
            },
            "columnDefs": [
                {
                    "orderable": false, // Deshabilitar ordenamiento
                    "searchable": true, // Permitir búsqueda
                    "targets": [0] // Primera columna
                },
                {
                    "orderable": false, // Deshabilitar ordenamiento
                    "searchable": true, // Permitir búsqueda
                    "targets": [1] // Primera columna
                },
                {
                    "orderable": false, // Deshabilitar ordenamiento
                    "searchable": true, // Permitir búsqueda
                    "targets": [2] // Primera columna
                },
                {
                    "orderable": true,
                    "searchable": false, // Deshabilitar búsqueda
                    "targets": "custom-sort",
                    "type": "custom-sort" // Usar el tipo de datos personalizado para la ordenación
                },
                {
                    "orderable": false, // Deshabilitar ordenamiento
                    "searchable": false, // Deshabilitar búsqueda
                    "targets": [-1] // Última columna
                }
            ]
        });
        
        var addButton = $('<button type="button" class="btn btn-dark bg-black ml-2" data-bs-toggle="modal" data-bs-target="#VentanaAddRiesgo">Añadir Riesgo</button>');

        // Insertar el botón antes de la barra de búsqueda
        $('.dataTables_filter').prepend(addButton);

        // Ajustar manualmente el ancho del botón
        addButton.width(784); // Ajusta el valor según sea necesario

        var alturaBarraBusqueda = $('.dataTables_filter').outerHeight();
        addButton.height(alturaBarraBusqueda - 18);

        addButton.css('margin-right', '10px');
    });
</script>
{% endblock %}